name: CI

on: [push]

env:
  CI: true
  DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - uses: webfactory/ssh-agent@v0.1.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}
      - name: Configure Git
        run: |
          git config --global user.email "ezra.m.brooks@gmail.com"
          git config --global user.name "Ezra Brooks"

      - name: Remove any existing pages folder
        run: git rm -rf pages

      - name: Git clone Pages repo
        run: git clone git@github.com:EzraBrooks/EzraBrooks.github.io.git pages

      - name: Remove contents of pages folder
        working-directory: ./pages
        run: git rm -r .

      - name: Yarn export
        run: yarn build && yarn export

      - name: Copy build output
        run: cp -rT export pages

      - name: Add and commit changes
        working-directory: ./pages
        run: |
          git add -A
          git commit -m "Update from source"

      - name: Git push
        working-directory: ./pages
        run: git push
        if: github.ref == 'refs/heads/master'
